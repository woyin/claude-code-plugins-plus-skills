name: Daily Skill Generator
on:
  schedule:
    - cron: "0 10 * * *"  # 10 AM UTC daily (5 AM EST)
  workflow_dispatch:  # Manual trigger

jobs:
  add-skill:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Find next plugin needing skills
        id: find
        run: |
          # Get all plugins
          PLUGINS=$(jq -r '.plugins[].name' .claude-plugin/marketplace.json)

          # Find first plugin WITHOUT agent-skills keyword
          NEXT_PLUGIN=$(jq -r '.plugins[] |
            select((.keywords[]? == "agent-skills") | not) |
            select(.category == "devops" or .category == "security" or .category == "testing" or .category == "ai-ml") |
            .name' .claude-plugin/marketplace.json | head -n 1)

          if [ -z "$NEXT_PLUGIN" ]; then
            echo "No plugins left to process!"
            exit 0
          fi

          # Get plugin details
          PLUGIN_PATH=$(jq -r ".plugins[] | select(.name == \"$NEXT_PLUGIN\") | .source" .claude-plugin/marketplace.json)
          PLUGIN_DESC=$(jq -r ".plugins[] | select(.name == \"$NEXT_PLUGIN\") | .description" .claude-plugin/marketplace.json)
          PLUGIN_CAT=$(jq -r ".plugins[] | select(.name == \"$NEXT_PLUGIN\") | .category" .claude-plugin/marketplace.json)

          echo "plugin_name=$NEXT_PLUGIN" >> $GITHUB_OUTPUT
          echo "plugin_path=$PLUGIN_PATH" >> $GITHUB_OUTPUT
          echo "plugin_desc=$PLUGIN_DESC" >> $GITHUB_OUTPUT
          echo "plugin_category=$PLUGIN_CAT" >> $GITHUB_OUTPUT

      - name: Create issue for Claude Code
        if: steps.find.outputs.plugin_name != ''
        uses: actions/github-script@v8
        with:
          script: |
            const pluginName = '${{ steps.find.outputs.plugin_name }}';
            const pluginPath = '${{ steps.find.outputs.plugin_path }}';
            const pluginDesc = '${{ steps.find.outputs.plugin_desc }}';
            const pluginCat = '${{ steps.find.outputs.plugin_category }}';

            const title = `Add Agent Skill: ${pluginName}`;
            const body = [
              '## Daily Skill Generator Task',
              '',
              `Plugin: ${pluginName}`,
              `Path: ${pluginPath}`,
              `Category: ${pluginCat}`,
              `Description: ${pluginDesc}`,
              '',
              '## Steps',
              '1. Read plugin README and commands/agents',
              `2. Create ${pluginPath}/skills/skill-adapter/SKILL.md`,
              '3. Add YAML frontmatter with name, description, allowed-tools',
              '4. Add "agent-skills" keyword to plugin.json',
              '5. Add "agent-skills" keyword to marketplace.extended.json',
              '6. Run: node scripts/sync-marketplace.cjs',
              `7. Create PR with branch: skill/${pluginName}`,
              '',
              '## Success Criteria',
              '- SKILL.md with proper YAML',
              '- Keywords updated in all files',
              '- Marketplace synced',
              '- PR created'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['daily-skill-generator', 'agent-skills']
            });
