name: "Gemini Code Review"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
  SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}

jobs:
  gemini-review:
    name: Gemini Code Review
    runs-on: ubuntu-latest
    # Only run if GCP secrets are configured
    if: ${{ vars.ENABLE_GEMINI_REVIEW == 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files: |
            **/*.ts
            **/*.tsx
            **/*.js
            **/*.jsx
            **/*.astro
            **/*.py
            **/*.md

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Install dependencies
        run: |
          pip install google-cloud-aiplatform

      - name: Get PR diff
        id: diff
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt
          echo "diff_size=$(wc -c < pr_diff.txt)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Gemini Code Review
        if: steps.diff.outputs.diff_size != '0'
        id: review
        run: |
          python3 << 'EOF'
          import os
          import json
          from google.cloud import aiplatform
          from vertexai.generative_models import GenerativeModel

          # Initialize Vertex AI
          aiplatform.init(project=os.environ.get('PROJECT_ID'), location='us-central1')

          # Read the diff
          with open('pr_diff.txt', 'r') as f:
              diff_content = f.read()

          # Truncate if too large (Gemini has context limits)
          max_chars = 100000
          if len(diff_content) > max_chars:
              diff_content = diff_content[:max_chars] + "\n... [truncated]"

          # Create prompt
          prompt = f"""You are an expert code reviewer. Review this pull request diff and provide constructive feedback.

          Focus on:
          1. Code quality and best practices
          2. Potential bugs or security issues
          3. Performance considerations
          4. Readability and maintainability
          5. Missing tests or documentation

          Be concise and actionable. Use markdown formatting.
          If the code looks good, say so briefly.

          PR Diff:
          ```diff
          {diff_content}
          ```

          Provide your review:"""

          # Call Gemini
          model = GenerativeModel("gemini-2.0-flash-exp")
          response = model.generate_content(prompt)

          review_text = response.text

          # Write to file for next step
          with open('review_output.md', 'w') as f:
              f.write(review_text)

          print("Review generated successfully")
          EOF

      - name: Post review comment
        if: steps.diff.outputs.diff_size != '0'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            let reviewBody = '';
            try {
              reviewBody = fs.readFileSync('review_output.md', 'utf8');
            } catch (e) {
              reviewBody = 'Unable to generate review.';
            }

            const comment = `## ðŸ¤– Gemini Code Review

            ${reviewBody}

            ---
            *Powered by Google Gemini via Vertex AI*`;

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Gemini Code Review')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Skip message
        if: steps.diff.outputs.diff_size == '0'
        run: echo "No relevant files changed, skipping review"
